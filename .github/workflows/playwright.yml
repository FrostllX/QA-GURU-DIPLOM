name: QA Guru Diplom tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
permissions:
  contents: write

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    env:
      # –ò–º—è –ª–∞—É–Ω—á–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤ TestOps –∏ –≤ Telegram
      LAUNCH_NAME: "QA Guru Diplom ‚Ä¢ run #${{ github.run_number }} ‚Ä¢ ${{ github.ref_name }}"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests
        run: npx playwright test

      # --- –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã Allure (–ª–æ–∫–∞–ª—å–Ω—ã–π –∏ gh-pages) ---
      - uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: allure-results
          path: allure-results/
          retention-days: 20

      - uses: simple-elf/allure-report-action@master
        if: always()
        id: allure-report
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      - name: Publish Allure report to GitHub Pages
        if: always() && github.event_name != 'pull_request'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
          
      # --- –ü–∞—Ä—Å–∏–º summary.json –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ---
      - name: Extract Allure stats
        if: always()
        id: allure-stats
        shell: bash
        run: |
          set -euo pipefail

          FILE="allure-report/widgets/summary.json"

          if [ -f "$FILE" ]; then
            echo "summary file found"
          else
            echo "No summary.json, creating a minimal one..."
            mkdir -p "$(dirname "$FILE")"
            cat > "$FILE" <<'EOF'
            {"statistic":{"total":0,"passed":0,"failed":0,"broken":0,"skipped":0,"unknown":0}}
          EOF
          fi

          # jq –æ–±—ã—á–Ω–æ –µ—Å—Ç—å –≤ Ubuntu image; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ—Å—Ç–∞–≤–∏–º
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

          TOTAL=$(jq -r '.statistic.total // 0' "$FILE")
          PASSED=$(jq -r '.statistic.passed // 0' "$FILE")
          FAILED=$(jq -r '.statistic.failed // 0' "$FILE")
          BROKEN=$(jq -r '.statistic.broken // 0' "$FILE")
          SKIPPED=$(jq -r '.statistic.skipped // 0' "$FILE")
          UNKNOWN=$(jq -r '.statistic.unknown // 0' "$FILE")

          {
           echo "total=$TOTAL"
           echo "passed=$PASSED"
           echo "failed=$FAILED"
           echo "broken=$BROKEN"
           echo "skipped=$SKIPPED"
           echo "unknown=$UNKNOWN"
          } >> "$GITHUB_OUTPUT"

      # --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ Allure TestOps ---
      - name: Upload to Allure TestOps
        if: always()
        id: upload-testops
        env:
          ALLURE_ENDPOINT: ${{ secrets.ALLURE_ENDPOINT }}
          ALLURE_PROJECT_ID: ${{ secrets.ALLURE_PROJECT_ID }}
          ALLURE_TOKEN: ${{ secrets.ALLURE_TOKEN }}
          LAUNCH_NAME: ${{ env.LAUNCH_NAME }}
        run: |
          set -euo pipefail
          
          # –°–∫–∞—á–∞—Ç—å allurectl
          curl -sL -o allurectl \
            https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64
          chmod +x allurectl

          # –ü–∏—à–µ–º –ü–û–õ–ù–´–ô –ª–æ–≥ –≤ —Ñ–∞–π–ª, –±–µ–∑ –ø–æ–ø—ã—Ç–æ–∫ JSON
          ./allurectl upload "allure-results" \
            -e "$ALLURE_ENDPOINT" \
            -t "$ALLURE_TOKEN" \
            --project-id "$ALLURE_PROJECT_ID" \
            --launch-name "$LAUNCH_NAME" \
            --launch-tags "github" \
            --launch-tags "${{ github.ref_name }}" \
            | tee allurectl.log

          # –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å ID –ª–∞—É–Ω—á–∞ –∏–∑ JSON; –µ—Å–ª–∏ jq –Ω–µ—Ç ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏–º
          LAUNCH_ID=$(grep -Eo 'Launch \[[0-9]+\]' allurectl.log | grep -Eo '[0-9]+' | tail -n1 || true)

          # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥—ë–º ‚Äî –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç—ã–º, –∑–∞—Ç–µ–º –¥–∞–¥–∏–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–ø–∏—Å–æ–∫ –ª–∞—É–Ω—á–µ–π —Å –ø–æ–∏—Å–∫–æ–º –ø–æ –∏–º–µ–Ω–∏
          if [ -z "${LAUNCH_ID:-}" ]; then
           LAUNCH_ID=$(grep -Eoi 'launch[ _-]?(id)?[=: ]+[0-9]+' allurectl.log | grep -Eo '[0-9]+' | tail -n1 || true)
          fi

          echo "launch_id=${LAUNCH_ID:-}" >> "$GITHUB_OUTPUT"
      # --- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram (—Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ —Å—Å—ã–ª–∫–æ–π –Ω–∞ Launch) ---
      - name: Notify Telegram
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          STATUS: ${{ job.status }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          REPORT_URL: ${{ secrets.ALLURE_REPORT_URL }}
          BRANCH: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          ALLURE_ENDPOINT: ${{ secrets.ALLURE_ENDPOINT }}
          ALLURE_PROJECT_ID: ${{ secrets.ALLURE_PROJECT_ID }}
          LAUNCH_NAME: ${{ env.LAUNCH_NAME }}
          LAUNCH_ID: ${{ steps.upload-testops.outputs.launch_id }}
          # —Å—á—ë—Ç—á–∏–∫–∏
          TOTAL:  ${{ steps.allure-stats.outputs.total }}
          PASSED: ${{ steps.allure-stats.outputs.passed }}
          FAILED: ${{ steps.allure-stats.outputs.failed }}
          BROKEN: ${{ steps.allure-stats.outputs.broken }}
          SKIPPED: ${{ steps.allure-stats.outputs.skipped }}
          UNKNOWN: ${{ steps.allure-stats.outputs.unknown }}
        run: |
          urlencode() {
          python3 - <<'PY'
          import sys, urllib.parse
          print(urllib.parse.quote(sys.argv[1]))
          PY
          }

          case "$STATUS" in
            success) EMOJI="‚úÖ";;
            failure) EMOJI="‚ùå";;
            cancelled) EMOJI="‚ö™";;
            *) EMOJI="‚ö†Ô∏è";;
          esac

          SHORT_SHA="${SHA:0:7}"

          # –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π launch: –µ—Å–ª–∏ –∑–Ω–∞–µ–º ID ‚Äî –ø—Ä—è–º–æ–π URL, –∏–Ω–∞—á–µ ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞ Launches —Å –ø–æ–∏—Å–∫–æ–º –ø–æ –∏–º–µ–Ω–∏
          if [ -n "$LAUNCH_ID" ]; then
            LAUNCH_URL="${ALLURE_ENDPOINT%/}/launch/${LAUNCH_ID}"
          else
            Q=$(urlencode "$LAUNCH_NAME")
            LAUNCH_URL="${ALLURE_ENDPOINT%/}/launches?projectId=${ALLURE_PROJECT_ID}&search=$Q"
          fi

          # –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Markdown)
          MSG="‚úÖ *CI: SUCCESS*\n\
          *Repo:* [${REPO}](https://github.com/${REPO})\n\
          *Branch:* \`${BRANCH}\`\n\
          *Commit:* \`${SHORT_SHA}\`\n\
          *Launch:* \`${LAUNCH_NAME}\`\n\n\
          *üìä Test Results:*\n\
          ‚Ä¢ *Total:* ${TOTAL}\n\
          ‚Ä¢ *Passed:* ${PASSED}\n\
          ‚Ä¢ *Failed:* ${FAILED}\n\
          ‚Ä¢ *Broken:* ${BROKEN}\n\
          ‚Ä¢ *Skipped:* ${SKIPPED}\n\n\
          [üîó View GitHub Actions Run](${RUN_URL})\n\
          [üìà View Allure Launch](${LAUNCH_URL})"

          # –î–æ–±–∞–≤–∏–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π Allure report (GitHub Pages), –µ—Å–ª–∏ –∑–∞–¥–∞–Ω
          if [ -n "$REPORT_URL" ]; then
            MSG="$MSG\n[Allure Report]($REPORT_URL)"
          fi

          # –û—Ç–ø—Ä–∞–≤–∫–∞
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            --data-urlencode text="$MSG" >/dev/null